#!/usr/bin/env python3
"""
Database Initialization Script for Returno Face Recognition System
Creates all tables and initializes the database with default data
"""

import os
import sys
from pathlib import Path

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from flask import Flask
from app.models.models import db, User, UserRole
from config.config import get_config
from app.utils.logging_config import setup_logging
from app.utils.encryption import validate_encryption_setup
import logging

logger = logging.getLogger(__name__)


def create_app():
    """Create Flask application"""
    app = Flask(__name__)
    
    # Load configuration
    config = get_config()
    app.config.from_object(config)
    
    # Initialize database
    db.init_app(app)
    
    # Setup logging
    setup_logging(app)
    
    return app


def init_database(app):
    """Initialize database with all tables"""
    with app.app_context():
        try:
            print("\n" + "="*70)
            print("üöÄ Returno Database Initialization")
            print("="*70 + "\n")
            
            # Create database directory if not exists
            db_path = app.config.get('SQLALCHEMY_DATABASE_URI', '').replace('sqlite:///', '')
            db_dir = os.path.dirname(db_path)
            if db_dir and not os.path.exists(db_dir):
                os.makedirs(db_dir, exist_ok=True)
                print(f"‚úì Created database directory: {db_dir}")
            
            # Drop all tables (use with caution!)
            print("\n‚ö†Ô∏è  Dropping existing tables...")
            db.drop_all()
            print("‚úì Existing tables dropped")
            
            # Create all tables
            print("\nüìä Creating database tables...")
            db.create_all()
            print("‚úì All tables created successfully")
            
            # Verify tables
            from sqlalchemy import inspect
            inspector = inspect(db.engine)
            table_names = inspector.get_table_names()
            
            print(f"\n‚úì Created {len(table_names)} tables:")
            for table in sorted(table_names):
                print(f"  ‚Ä¢ {table}")
            
            # Create default admin user
            print("\nüë§ Creating default admin user...")
            create_default_admin()
            
            # Verify encryption
            print("\nüîê Validating encryption setup...")
            encryption_status = validate_encryption_setup()
            if encryption_status['configured']:
                print(f"‚úì {encryption_status['message']}")
            else:
                print(f"‚ö†Ô∏è  {encryption_status['message']}")
            
            # Show database info
            print("\nüìà Database Statistics:")
            print(f"  ‚Ä¢ Database: {db_path}")
            if os.path.exists(db_path):
                size_mb = os.path.getsize(db_path) / (1024 * 1024)
                print(f"  ‚Ä¢ Size: {size_mb:.2f} MB")
            
            print("\n" + "="*70)
            print("‚úÖ Database initialization complete!")
            print("="*70)
            
            print("\nüìù Next Steps:")
            print("  1. Change default admin password: admin123")
            print("  2. Configure .env file with encryption key")
            print("  3. Copy your ML models to models/ directory")
            print("  4. Run: python app.py")
            print()
            
            return True
            
        except Exception as e:
            print(f"\n‚ùå Error initializing database: {e}")
            logger.exception("Database initialization failed")
            return False


def create_default_admin():
    """Create default admin user"""
    try:
        # Check if admin exists
        admin = User.query.filter_by(username='admin').first()
        
        if admin:
            print("  ‚ö†Ô∏è  Admin user already exists")
            return
        
        # Create admin user
        admin = User(
            username='admin',
            email='admin@returno.local',
            full_name='System Administrator',
            phone='+1234567890',
            role=UserRole.ADMIN,
            is_active=True,
            is_verified=True
        )
        admin.set_password('admin123')
        
        db.session.add(admin)
        db.session.commit()
        
        print("  ‚úì Admin user created")
        print("  ‚Ä¢ Username: admin")
        print("  ‚Ä¢ Password: admin123")
        print("  ‚Ä¢ ‚ö†Ô∏è  IMPORTANT: Change password in production!")
        
    except Exception as e:
        print(f"  ‚ùå Error creating admin user: {e}")
        db.session.rollback()
        raise


def create_sample_data(app):
    """Create sample data for testing (optional)"""
    with app.app_context():
        try:
            print("\nüì¶ Creating sample data...")
            
            # Create sample public user
            from app.models.models import User, UserRole
            
            public_user = User.query.filter_by(username='john_doe').first()
            if not public_user:
                public_user = User(
                    username='john_doe',
                    email='john@example.com',
                    full_name='John Doe',
                    phone='+1987654321',
                    role=UserRole.PUBLIC_REPORTER,
                    is_active=True,
                    is_verified=True
                )
                public_user.set_password('password123')
                db.session.add(public_user)
            
            # Create sample guardian user
            guardian = User.query.filter_by(username='jane_guardian').first()
            if not guardian:
                guardian = User(
                    username='jane_guardian',
                    email='jane@example.com',
                    full_name='Jane Guardian',
                    phone='+1555555555',
                    role=UserRole.GUARDIAN,
                    is_active=True,
                    is_verified=True
                )
                guardian.set_password('password123')
                db.session.add(guardian)
            
            db.session.commit()
            print("  ‚úì Sample users created")
            
            # Create sample success story
            from app.models.models import SuccessStory
            
            story = SuccessStory.query.first()
            if not story:
                story = SuccessStory(
                    title="Child Reunited with Family After 3 Days",
                    description="Thanks to the quick response of our community and the help of facial recognition technology, an 8-year-old child was safely reunited with their family after being missing for 3 days.",
                    age_group="child",
                    location_general="New York City",
                    missing_duration_days=3,
                    is_published=True
                )
                db.session.add(story)
                db.session.commit()
                print("  ‚úì Sample success story created")
            
            print("‚úì Sample data creation complete")
            
        except Exception as e:
            print(f"‚ùå Error creating sample data: {e}")
            db.session.rollback()


def verify_database(app):
    """Verify database setup"""
    with app.app_context():
        try:
            print("\nüîç Verifying database setup...")
            
            # Test connection
            db.session.execute('SELECT 1')
            print("  ‚úì Database connection working")
            
            # Check admin user
            admin = User.query.filter_by(username='admin').first()
            if admin:
                print(f"  ‚úì Admin user exists (ID: {admin.id})")
            else:
                print("  ‚ö†Ô∏è  Admin user not found")
            
            # Count records
            from app.models.models import (
                User, MissingReport, FileAttachment, MatchResult,
                Notification, ConsentLog, AuditLog
            )
            
            counts = {
                'Users': User.query.count(),
                'Reports': MissingReport.query.count(),
                'Attachments': FileAttachment.query.count(),
                'Matches': MatchResult.query.count(),
                'Notifications': Notification.query.count(),
                'Consent Logs': ConsentLog.query.count(),
                'Audit Logs': AuditLog.query.count()
            }
            
            print("\n  üìä Record counts:")
            for table, count in counts.items():
                print(f"    ‚Ä¢ {table}: {count}")
            
            print("\n‚úì Database verification complete")
            return True
            
        except Exception as e:
            print(f"‚ùå Database verification failed: {e}")
            return False


def main():
    """Main execution"""
    # Create Flask app
    app = create_app()
    
    # Initialize database
    success = init_database(app)
    
    if not success:
        print("\n‚ùå Initialization failed. Please check the errors above.")
        sys.exit(1)
    
    # Ask if user wants sample data
    response = input("\n‚ùì Create sample data for testing? (y/n): ").lower().strip()
    if response == 'y':
        create_sample_data(app)
    
    # Verify setup
    verify_database(app)
    
    print("\n‚úÖ All done! Your database is ready to use.")
    print("   Start the server with: python app.py\n")


if __name__ == "__main__":
    main()
